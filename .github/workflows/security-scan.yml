name: ğŸ”’ Shift-Left Security Scan (Terraform)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  TERRAFORM_VERSION: 1.6.0
  TERRAFORM_PATH: './terraform/'

jobs:
  security-scan:
    name: ğŸ›¡ï¸ Terraform Security Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      security-events: write
      actions: read

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}

    - name: âœ… Terraform Validation
      run: |
        echo "ğŸ” Validating Terraform configuration..."
        cd ${{ env.TERRAFORM_PATH }}
        terraform init -backend=false
        terraform validate
        echo "âœ… Terraform validation completed"

    - name: ğŸ” FCS CLI Security Scan
      id: fcs-scan
      uses: crowdstrike/fcs-action@v3.0.0
      with:
        falcon_client_id: ${{ secrets.FALCON_CLIENT_ID }}
        falcon_region: 'us-2'
        path: ${{ env.TERRAFORM_PATH }}
        project_name: 'shift-left-security-demo-terraform'
        report_formats: json,sarif
        output_path: './fcs-results/'
        policy_rule: 'default-iac-alert-rule'
        fail_on: 'critical=5,high=10'
        minimum_severity: low
        upload_results: true
      env:
        FALCON_CLIENT_SECRET: ${{ secrets.FALCON_CLIENT_SECRET }}

    - name: ğŸ“Š Display Security Scan Results
      if: always()
      run: |
        FCS_EXIT_CODE="${{ steps.fcs-scan.outputs.exit-code }}"

        echo "ğŸ” FCS CLI Security Scan Results"
        echo "================================="
        echo "Exit Code: $FCS_EXIT_CODE"
        echo ""

        if [ "$FCS_EXIT_CODE" = "0" ]; then
          echo "âœ… No critical security issues found that exceed the threshold"
          echo "ğŸ“¤ Results uploaded to CrowdStrike Falcon Console"
        else
          echo "âš ï¸ Security issues detected that exceed configured thresholds"
          echo "ğŸ“¤ Detailed results uploaded to CrowdStrike Falcon Console"
        fi

        echo ""
        echo "ğŸ“ Scan Results Directory:"
        if [ -d "./fcs-results" ]; then
          ls -la ./fcs-results/
          echo ""

          # Display summary if JSON results exist
          if ls ./fcs-results/*.json 1> /dev/null 2>&1; then
            echo "ğŸ“‹ Security Issues Summary:"
            echo "=========================="

            for json_file in ./fcs-results/*.json; do
              if [ -f "$json_file" ]; then
                echo "ğŸ“„ File: $(basename "$json_file")"

                # Try to parse summary using jq if available
                if command -v jq &> /dev/null; then
                  CRITICAL=$(cat "$json_file" | jq -r '.detection_summary.critical // 0' 2>/dev/null || echo "0")
                  HIGH=$(cat "$json_file" | jq -r '.detection_summary.high // 0' 2>/dev/null || echo "0")
                  MEDIUM=$(cat "$json_file" | jq -r '.detection_summary.medium // 0' 2>/dev/null || echo "0")
                  INFO=$(cat "$json_file" | jq -r '.detection_summary.informational // 0' 2>/dev/null || echo "0")
                  TOTAL=$(cat "$json_file" | jq -r '.detection_summary.total // 0' 2>/dev/null || echo "0")

                  # If detection_summary doesn't exist, count from rule_detections
                  if [ "$TOTAL" = "0" ]; then
                    CRITICAL=$(cat "$json_file" | jq -r '[.rule_detections[]? | select(.severity == "CRITICAL")] | length' 2>/dev/null || echo "0")
                    HIGH=$(cat "$json_file" | jq -r '[.rule_detections[]? | select(.severity == "HIGH")] | length' 2>/dev/null || echo "0")
                    MEDIUM=$(cat "$json_file" | jq -r '[.rule_detections[]? | select(.severity == "MEDIUM")] | length' 2>/dev/null || echo "0")
                    INFO=$(cat "$json_file" | jq -r '[.rule_detections[]? | select(.severity == "INFORMATIONAL")] | length' 2>/dev/null || echo "0")
                    TOTAL=$(($CRITICAL + $HIGH + $MEDIUM + $INFO))
                  fi

                  echo "   ğŸ”´ Critical: $CRITICAL"
                  echo "   ğŸŸ  High: $HIGH"
                  echo "   ğŸŸ¡ Medium: $MEDIUM"
                  echo "   ğŸ”µ Info: $INFO"
                  echo "   ğŸ“Š Total: $TOTAL"

                  # Show all security findings
                  if [ "$TOTAL" -gt "0" ]; then
                    echo ""
                    echo "ğŸ“ All Security Findings:"
                    cat "$json_file" | jq -r '.rule_detections[]? | "   â€¢ [\(.severity)] \(.rule_name): \(.details // .description // "Security issue detected")"' 2>/dev/null || echo "   (Unable to parse findings details)"
                  fi
                else
                  echo "   âš ï¸ jq not available - cannot parse detailed results"
                  echo "   Full raw results:"
                  cat "$json_file"
                fi
                echo ""
              fi
            done
          else
            echo "âŒ No JSON results found"
          fi
        else
          echo "âŒ No results directory found"
        fi

        echo ""
        echo "ğŸ¯ Demo Purpose:"
        echo "This Terraform configuration contains intentional security misconfigurations"
        echo "to demonstrate shift-left security scanning capabilities with CrowdStrike FCS CLI."
        echo ""
        echo "ğŸ”— View detailed results in CrowdStrike Falcon Console"

    - name: ğŸ“¦ Store Security Scan Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: fcs-security-scan-results-${{ github.run_number }}
        path: |
          ./fcs-results/
        retention-days: 30

    - name: ğŸ” Upload SARIF to GitHub Security
      if: always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: './fcs-results/'
        category: 'FCS-CLI-IaC-Scan'

    - name: ğŸ“ Comment PR with Results Summary
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');

          let comment = `## ğŸ”’ Security Scan Results\\n\\n`;
          comment += `**FCS CLI Exit Code:** \`${{ steps.fcs-scan.outputs.exit-code }}\`\\n\\n`;

          if ('${{ steps.fcs-scan.outputs.exit-code }}' === '0') {
            comment += `âœ… **No critical security issues** found above configured thresholds\\n\\n`;
          } else {
            comment += `âš ï¸ **Security issues detected** that exceed configured thresholds\\n\\n`;
          }

          comment += `ğŸ“Š **Scan Details:**\\n`;
          comment += `- Path Scanned: \`${{ env.TERRAFORM_PATH }}\`\\n`;
          comment += `- Project: \`shift-left-security-demo-terraform\`\\n`;
          comment += `- Formats: JSON, SARIF\\n\\n`;

          comment += `ğŸ”— **View detailed results in:**\\n`;
          comment += `- CrowdStrike Falcon Console\\n`;
          comment += `- GitHub Security tab (Security â†’ Code scanning alerts)\\n\\n`;
          comment += `ğŸ“ **Artifacts:** Check the workflow run for detailed scan results\\n\\n`;
          comment += `---\\n`;
          comment += `*This is an automated security scan for the shift-left security demo*`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: ğŸ¯ Demo Status Summary
      if: always()
      run: |
        echo ""
        echo "ğŸ¯ Shift-Left Security Demo Summary"
        echo "=================================="
        echo "âœ… Terraform configuration validated"
        echo "âœ… Security scan completed with FCS CLI"
        echo "âœ… Results uploaded to CrowdStrike Falcon Console"
        echo "âœ… SARIF results uploaded to GitHub Security Hub"
        echo "âœ… Artifacts stored for download"
        echo ""
        if [ "${{ steps.fcs-scan.outputs.exit-code }}" = "0" ]; then
          echo "ğŸ“ˆ Demo Status: Scan completed successfully"
        else
          echo "ğŸ“ˆ Demo Status: Security issues detected (as expected for demo)"
        fi
        echo ""
        echo "This demonstrates shift-left security principles:"
        echo "â€¢ Early detection of IaC security issues"
        echo "â€¢ Automated scanning in CI/CD pipeline"
        echo "â€¢ Integration with enterprise security platforms"
        echo "â€¢ Clear feedback to development teams"